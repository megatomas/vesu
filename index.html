<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="styles.css" rel="stylesheet" type="text/css"/>
<style>
    .error {
      border: 2px solid red;
    }
  </style>
<!-- Подключение стилей flatpickr -->
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet"/><script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script></head>
<body>
<form data-content-type="web_app_data" enctype="multipart/form-data">
<div><label for="regNumber">Рег. номер</label><input id="regNumber" name="regNumber" placeholder="Введите рег. номер..." type="text"/></div>
<div style="margin: 10px 0;">
<label>Источник подсказок:</label>
<div class="switch-labels">
<span class="switch-label">Все весы</span>
<label class="switch">
<input id="dataToggle" type="checkbox"/>
<span class="slider round"></span>
</label>
<span class="switch-label">Лабораторные</span>
</div>
<label><span id="toggleLabel">non_laboratory_data.json</span></label>
</div>
<div>
<label for="client">Клиент</label>
<input id="client" name="client" placeholder="Клиент" type="text"/>
</div>
<div>
<label for="model">Модель</label>
<input id="model" name="model" placeholder="Модель" type="text"/>
</div>
<div>
    <label for="suitability">Пригодность</label>
    <select id="suitability" name="suitability">
    <option value="пригодный" selected>пригодный</option>
    <option value="не пригодный">не пригодный</option>
</select>
</div>
<div>
<label for="Modification">Модификация</label>
<input id="Modification" name="Modification" placeholder="Модификация" type="text"/>
</div>
  <label for="year_of_release">Год Выпуска</label>
<input id="year_of_release" name="year_of_release" placeholder="Год Выпуска" type="text"/>
</div>
<div>
<label for="npv">НПВ</label>
<select id="npv" name="npv">
<option disabled="" selected="" value="">Выберите НПВ</option>
<option value="1">1</option><option value="2.5">2.5</option><option value="3">3</option><option value="4.7">4.7</option></select>
</div>
<div id="error"></div>
<div class="button-group">
<button id="submit" type="submit">Отправить</button>
<button id="reset" style="margin-left: 10px" type="reset">Отмена</button>
</div>
<div><label for="verificationDate">Дата следующей поверки</label><input id="verificationDate" name="verificationDate" type="date" value="2026-10-22"/></div></form>
<script>
    $(document).ready(function() {

        function updateSelect() {
            var selectElement = $('#npv');
            selectElement.empty();
            var data = [];

            // If the toggle is checked, use data from npv_laboratory.json, otherwise use data from npv_all.json
            if ($('#dataToggle').prop('checked')) {
                data = [5, 6.1];
            } else {
                data = [1, 2.5, 3, 4.7];
            }

            // Add the default option
            selectElement.append('<option disabled selected value>Выберите НПВ</option>');

            // Add the options from the selected data source
            data.forEach(function(item) {
                selectElement.append('<option value=' + item + '>' + item + '</option>');
            });
        }

        // Handle the change event of the toggle switch
        $('#dataToggle').on('change', updateSelect);

        // Call the function on initial load
        updateSelect();
    });
</script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

<script>
    let dataSource = "non_laboratory_data.json";

    document.getElementById('dataToggle').addEventListener('change', function() {
        if (this.checked) {
            dataSource = "laboratory_data.json";
            document.getElementById("toggleLabel").innerText = "laboratory_data.json";
        } else {
            dataSource = "non_laboratory_data.json";
            document.getElementById("toggleLabel").innerText = "non_laboratory_data.json";
        }
        updateSuggestions();
    });

    function updateSuggestions() {
        fetch(dataSource)
            .then(response => response.json())
            .then(data => {
                let suggestions = [];
                for (let item of data) {
                    let combinedString = `Наименование: ${item["Наименование"]}, Наименование типа СИ: ${item["Наименование типа СИ"]}, Изготовитель: ${item["Изготовитель"]}`;
                    suggestions.push(combinedString);
                }

                $("#regNumber").autocomplete({
                    source: function(request, response) {
                        let matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                        response(suggestions.filter(s => matcher.test(s)));
                    }
                });
            });
    }

   document.addEventListener('DOMContentLoaded', function() {
    updateSuggestions();

    // Найти элемент с id "toggleLabel" и скрыть его
    var toggleLabel = document.getElementById("toggleLabel");
    toggleLabel.style.display = "none";
});
</script>

<script>
    $(document).ready(function() {
        var verificationDate = new Date();
        verificationDate.setFullYear(verificationDate.getFullYear() + 3);
        verificationDate.setDate(verificationDate.getDate() + 1);
        $('#verificationDate').val(verificationDate.toISOString().slice(0, 10));
    });
</script>
</body>
</html>

<script>
    let tg = window.Telegram.WebApp;
    let submit = document.getElementById("submit");
    let reset = document.getElementById("reset");

    function loadJSONFile(file, callback) {
      var xhr = new XMLHttpRequest();
      xhr.overrideMimeType('application/json');
      xhr.open('GET', file, true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          callback(xhr.responseText);
        }
      };
      xhr.send(null);
    }

  submit.addEventListener("click", (event) => {
    event.preventDefault();
    let client = document.getElementById("client");
    let model = document.getElementById("model");
    let Modification = document.getElementById("Modification");
    let npvSelect = document.getElementById("npv");


    let data = {
      client: client.value,
      model: model.value,
      Modification: Modification.value,
      npv: npv.value,
    };
    // Send data to Telegram
    tg.sendData(JSON.stringify(data));
    // Close the window
    tg.close();
  });
  reset.addEventListener("click", () => {
    // Actions when "Cancel" button is clicked
    tg.close();
  });
  document.addEventListener("DOMContentLoaded", function() {

document.getElementById('dataToggle').addEventListener('change', function() {
    if (this.checked) {
        dataSource = "npv_laboratory.json";
        document.getElementById("toggleLabel").innerText = "laboratory_data.json";
    } else {
        dataSource = "npv_all.json";
        document.getElementById("toggleLabel").innerText = "non_laboratory_data.json";
    }
    updateNPVOptions();
});
function updateNPVOptions() {
    fetch(dataSource)
        .then(response => response.json())
        .then(data => {
            // Очищаем текущие опции в выпадающем списке
            npvSelect.innerHTML = '<option value="" disabled selected>Выберите НПВ</option>';

            // Заполняем выпадающий список согласно данными из файла
            for (let item of data) {
                let option = document.createElement('option');
                option.value = item.value; // Предполагается, что в файле есть поле "value"
                option.textContent = item.label; // Предполагается, что в файле есть поле "label"
                npvSelect.appendChild(option);
            }
        });
}
updateNPVOptions();


</script>